@model HotelGolfBooking.Models.hotel_room

@{
    ViewBag.Title = "Create";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}
<div class="col-md-8" id="listRoom" style="display:none;">
        
</div>
<div class="col-md-8">
<h2>Nhập thêm phòng cho khách sạn @Session["hotelName"]</h2>
@using (Html.BeginForm("Create", "HotelRoom", FormMethod.Post, new { id = "EditForm" })) {
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(false)

    <fieldset>
        <div class="col-md-6">
              <div class="form-group">
                <label for="room" style="width:auto;display:block;">Tên phòng</label>
                <input name="roomname" type="text" id="roomname" value="" class="form-control" placeholder="Nhập tên"/>                
                <input name="idhotel" type="hidden" id="idhotel" value="@Session["idhotel"]" class="form-control" />                
                <input name="hotelname" type="hidden" id="hotelname" value="@Session["hotelname"]" class="form-control" />                
              </div>
         </div>
        <div class="col-md-6">
              <div class="form-group">
                <label for="room" style="width:auto;display:block;">Diện tích(m2)</label>
                <input name="square" type="text" id="square" value="" class="form-control" placeholder="m2" onblur="checkSquare();"/>                                
              </div>
         </div>
        <div class="col-md-6">
              <div class="form-group">
                <label for="room" style="width:auto;display:block;">Có ăn sáng</label>                
                <input name="breakfast" type="text" id="breakfast" value="ăn sáng" class="form-control" placeholder="ăn sáng"/>
                <input type="checkbox" id="br" onclick="checkBR(this,'ăn sáng');">ăn sáng
                <input type="checkbox" id="hl" onclick="checkBR(this,'ăn trưa');">ăn trưa
                <input type="checkbox" id="dn" onclick="checkBR(this,'ăn tối');">ăn tối 
                <input type="checkbox" id="sp" onclick="checkBR(this, 'spa');">spa                                                              
              </div>
        </div>
        <div class="col-md-6">
              <div class="form-group">
                <label for="room" style="width:auto;display:block;">Có giường phụ</label>                
                <select class="form-control" name="extrabed" id="extrabed" >
                    <option selected value="1">Có</option>
                    <option value="0">Không</option>
                </select>                         
              </div>
        </div>
        <div class="col-md-6">
              <div class="form-group">
                <label for="room" style="width:auto;display:block;">Phụ thu giường phụ</label>
                <input name="extrabedfee" type="text" id="extrabedfee" value="0" class="form-control" placeholder="" onblur="checkPrice(this);"/>                                
              </div>
         </div>
        <div class="col-md-6">
              <div class="form-group">
                <label for="room" style="width:auto;display:block;">Phụ thu khác</label>
                <input name="extraotherfee" type="text" id="extraotherfee" value="0" class="form-control" placeholder="" onblur="checkPrice(this);"/>                                
              </div>
         </div>
        <div class="col-md-6">
              <div class="form-group">
                <label for="room" style="width:auto;display:block;">Ghi chú phụ thu</label>
                <input name="notefee" type="text" id="notefee" value="" class="form-control" placeholder="ví dụ: lễ tết, cao điểm.." />                                
              </div>
         </div>
        <div class="col-md-6">
              <div class="form-group">
                <label for="room" style="width:auto;display:block;">Max of Adults</label>                
                <input name="maxofadult" type="text" id="maxofadult" value="2" class="form-control"/> 
                <input name="nonsmoking" type="hidden" id="nonsmoking" value="1" class="form-control" />  
                <input name="idroom" type="hidden" id="idroom" value="@ViewBag.idroom" />                         
              </div>
        </div>
        <div class="col-md-6">
              <div class="form-group">
                <label for="room" style="width:auto;display:block;">Số lượng phòng</label>
                <input name="noofroom" type="text" id="noofroom" value="" class="form-control" placeholder="Gõ số lượng"/>                                
              </div>
         </div>
        <div class="col-md-6">
              <div class="form-group">
                <label for="room" style="width:auto;display:block;">Hiển thị giá</label>                
                <select class="form-control" name="showprice" id="showprice">
                    <option selected value="0">Có</option>
                    <option value="1">Không</option>
                </select>                         
              </div>
        </div>
        <div class="form-group">
              <div id="listMonth" name="listMonth">
                   <table style="border:1px solid #ff6a00;width:90%;">
                        <tr><th colspan="12" nowrap>Chọn tháng</th></tr>
                        <tr>
                            <td onclick="chooseMonth(1);" id="bgm1" style="border:1px solid #ff6a00;color:#fff;background-color:blue;cursor:pointer;"><B>1</B></td>
                            <td onclick="chooseMonth(2);" id="bgm2" style="border:1px solid #ff6a00;color:#fff;background-color:blue;cursor:pointer;"><B>2</B></td>
                            <td onclick="chooseMonth(3);" id="bgm3" style="border:1px solid #ff6a00;color:#fff;background-color:blue;cursor:pointer;"><B>3</B></td>
                            <td onclick="chooseMonth(4);" id="bgm4" style="border:1px solid #ff6a00;color:#fff;background-color:blue;cursor:pointer;"><B>4</B></td>
                            <td onclick="chooseMonth(5);" id="bgm5" style="border:1px solid #ff6a00;color:#fff;background-color:blue;cursor:pointer;"><B>5</B></td>
                            <td onclick="chooseMonth(6);" id="bgm6" style="border:1px solid #ff6a00;color:#fff;background-color:blue;cursor:pointer;"><B>6</B></td>
                            <td onclick="chooseMonth(7);" id="bgm7" style="border:1px solid #ff6a00;color:#fff;background-color:blue;cursor:pointer;"><B>7</B></td>
                            <td onclick="chooseMonth(8);" id="bgm8" style="border:1px solid #ff6a00;color:#fff;background-color:blue;cursor:pointer;"><B>8</B></td>
                            <td onclick="chooseMonth(9);" id="bgm9" style="border:1px solid #ff6a00;color:#fff;background-color:blue;cursor:pointer;"><B>9</B></td>
                            <td onclick="chooseMonth(10);" id="bgm10" style="border:1px solid #ff6a00;color:#fff;background-color:blue;cursor:pointer;"><B>10</B></td>
                            <td onclick="chooseMonth(11);" id="bgm11" style="border:1px solid #ff6a00;color:#fff;background-color:blue;cursor:pointer;"><B>11</B></td>
                            <td onclick="chooseMonth(12);" id="bgm12" style="border:1px solid #ff6a00;color:#fff;background-color:blue;cursor:pointer;"><B>12</B></td>
                        </tr>
                   </table>
              </div>
              <table id="listPrice">
                <tr><th>Giá phòng</th><th>Trong các tháng</th><th><th></tr>
                <tr>
                    <td><input name="price0" type="text" id="price0" value="" class="form-control" placeholder="Nhập giá" onblur="checkPrice(this);" onfocus="getIndex(0);"/></td>                                
                    <td><input name="month0" type="text" id="month0" value="" class="form-control" placeholder="ví dụ:,1,,2,,3,,4," onblur="checkMonth(this);" onfocus="getIndex(0);"/></td>  
                    <td><input type="button" value="+Thêm" onclick="addItem();">|<input type="button" value="-Xóa" onclick="removeItem();"></td>
                </tr>       
              </table>
         </div>
         <p>
           <button type="button" class="btn btn-info" onclick="checkField();">Thêm mới</button>
        </p>
    </fieldset>
}
<div>
    <a href="/Hotels/Edit/@Session["idhotel"]">Quay lại</a>    
</div>
</div>
<script>
    var bgcolor = ["lime", "red", "green", "grey", "yellow", "orange","brown","lime"];
    var currentIndex=0;
    var totalitem = 1;
    function getIndex(value){
        currentIndex=value;
    }
    function chooseMonth(v){
        $("#bgm"+v).css("background-color",bgcolor[currentIndex%7]);
        if (document.getElementById("month"+currentIndex).value.indexOf(","+v+",")<0){
            document.getElementById("month"+currentIndex).value+=","+v+",";
        }else{
            document.getElementById("month"+currentIndex).value=document.getElementById("month"+currentIndex).value.replace(","+v+",","");
            $("#bgm"+v).css("background-color","blue");
        }
    }
    function addItem() {
        var content = "";
        content+="<tr id=tr"+totalitem+">";
        content+= " <td><input name=\"price"+totalitem+"\" type=\"text\" id=\"price"+totalitem+"\" value=\"\" class=\"form-control\" placeholder=\"Nhập giá\" onblur=\"checkPrice(this);\" onfocus=\"getIndex("+totalitem+");\"/></td>";                                
        content+= " <td><input name=\"month"+totalitem+"\" type=\"text\" id=\"month"+totalitem+"\" value=\"\" class=\"form-control\" placeholder=\"ví dụ:,1,2,3,12,\" onblur=\"checkMonth(this);\" onfocus=\"getIndex("+totalitem+");\"/></td>";  
        content+= " <td><input type=\"button\" value=\"+Thêm\" onclick=\"addItem();\">|<input type=\"button\" value=\"-Xóa\" onclick=\"removeItem("+totalitem+");\"></td>";
        content += "</tr>";
        $("#listPrice").append(content);
        totalitem++;
    }
    function checkMonth(obj){
        //var val=removeSpecialCharater(obj.value);
        //if (isNaN(val))
        //{
        //    alert("Dữ liệu phải định dạng kiểu ,1,2,3,4, (có đủ dấu phẩy ở hai đầu)");
        //    obj.focus();
        //    return false;
        //}
        //var s1=obj.value.substring(0,1);
        //var s2=obj.value.substring(obj.value.length-1,obj.value.length);
       
        //if (s1!=","|| s2!=","){
        //    alert("Dữ liệu phải định dạng kiểu ,1,2,3,4, (có đủ dấu phẩy ở hai đầu)");
        //    obj.focus();
        //    return false;
        //}
    }
    function removeItem(index) {
        $("#tr" + index).remove();
    }
    function checkBR(obj, value) {
        if (obj.checked) {
            if (document.getElementById("breakfast").value.indexOf(value)<0) document.getElementById("breakfast").value += ", " + value;
        } else {
            document.getElementById("breakfast").value = document.getElementById("breakfast").value.replace(", " + value, "");
        }
    }
    getHotelRoomList(@Session["idhotel"],@DateTime.Now.Month);
    function getHotelRoomList(value,month) {
        var formdata = new FormData(); //FormData object
        formdata.append("idhotel", value);
        formdata.append("fromdate", month);
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/HotelRoom/getHotelRoomListBasic');
        xhr.send(formdata);
        var content = "";
        
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                var news = '{"news":' + xhr.responseText + '}';
                //alert(news);
                var json_parsed = $.parseJSON(news);
                content = "<h4>Danh sách phòng</h4><table class=tbl_price_room><tr><th>Tên phòng</th><th>Giá(tháng "+month+")</th><th>Diện tích</th><th>Ăn sáng</th><th>Giường phụ</th><th>Số lượng</th><th>Phụ phí</th><th>Hiển thị giá</th><th></th><tr>";
                $("#listRoom").show();
                $("#listRoom").html();
                for (var i = 0; i < json_parsed.news.length; i++) {
                    if (json_parsed.news[i]) {
                        
                        var n=json_parsed.news[i];
                        var breakfast=n.breakfast;
                        var extrabed="không";
                        var showprice="có";
                        //alert(name);
                        var extrafee="giường phụ: "+n.extrabedfee+"\r\nkhác:"+n.extraotherfee;
                        if (n.extrabed==1){extrabed="có";}
                        if (n.showprice==1){showprice="không";}
                        content += "<tr><td>" + n.roomname + "</td><td>" + n.price + "</td><td>" + n.square + "</td><td>" + breakfast + "</td><td>" + extrabed + "</td><td>" + n.noofroom + "</td><td>"+extrafee+"</td><td>"+showprice+"</td><td>&nbsp;<a href=\"/HotelRoom/Edit/" + n.id + "\">Sửa</a><a href=\"/HotelRoom/Delete/" + n.id + "\"> Xóa</a></td><tr>";//, &nbsp;<a href=\"/HotelPrice/Create?idroom=" + n.id + "\" target=\"_blank\">Nhập giá</a>
                    }
                }
                //alert(content);
                content += "</table>";
                $("#listRoom").html(content);
                //alert(news);
            }
        }
    }
    function checkSquare() {
        document.getElementById("square").value = parseInt(removeSpecialCharater(document.getElementById("square").value));
    }
    function checkPrice(obj) {
        //document.getElementById("price").value = parseInt(removeSpecialCharater(document.getElementById("price").value));
        obj.value=parseInt(removeSpecialCharater(obj.value));
    }
    function checkField() {
        if (document.getElementById("roomname").value == "") {
            alert("Nhập tên phòng!");
            document.getElementById("roomname").focus();
            return false;
        }
        
        if (document.getElementById("noofroom").value == "" || isNaN(document.getElementById("noofroom").value)) {
            alert("Nhập số lượng phòng!");
            document.getElementById("noofroom").focus();
            return false;
        }
        var formdata = new FormData(); //FormData object
        formdata.append("idhotel", @Session["idhotel"]);
        formdata.append("hotelname", "@Html.Raw(@Session["hotelname"])");
        formdata.append("totalitem", totalitem);
        formdata.append("idroom", -1);
        formdata.append("roomname", "@ViewBag.idroom");
        for (var i = 0; i < totalitem; i++) {
            if (!document.getElementById("price" + i)||!document.getElementById("month" + i)) continue;
            if (document.getElementById("price" + i).value == 0 || isNaN(document.getElementById("price" + i).value)) {
                alert("Nhập giá");
                document.getElementById("price" + i).focus();
                return;
            }
            if (document.getElementById("month" + i).value == 0) {
                alert("Nhập giai đoạn");
                document.getElementById("month" + i).focus();
                return;
            }
            formdata.append("price" + i, document.getElementById("price" + i).value);
            formdata.append("month" + i, document.getElementById("month" + i).value);
        }
        
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/HotelPrice/addNewItem');
        xhr.send(formdata);
        var content = "";
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                if (xhr.responseText=="1"){
                    document.getElementById("EditForm").submit();
                }else{
                    alert("Chương trình đang cập nhật, xin quay lại sau!");   
                }
            }
        }
        
    }
</script>