@{
    ViewBag.Title = "Đặt sân Golf";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="container">
  <div class="row">
    <!-- Contact details -->
    <section class="contact-details">
      <div class="col-md-5">
        <h2 class="lined-heading  mt50"><span>Thông Tin</span></h2>
        <!-- Panel -->
        <div class="panel panel-default text-center">
          <div class="panel-heading">
            <div class="panel-title"><i class="fa fa-star"></i> <strong>Giới thiệu</strong></div>
          </div>
          <div class="panel-body" style="text-align:left;">
            <p style="text-align:left;float:left;display:block;">@Html.Raw(@ViewBag.des)</p>
            @if (ViewBag.note != null) { 
                <p onclick="$('#notegolf').show();" style="cursor:pointer;">Xem thêm..</p>
                <div id="notegolf" style="display:none;">@Html.Raw(@ViewBag.note)</div>
            }
			<table id="listNewsGolf">
				
			</table>
          </div>
        </div>
        
      </div>
    </section>
    
    <!-- Contact form -->
    <section id="contact-form" class="mt50">
      <div class="col-md-7">
        <h2 class="lined-heading"><span>Đặt chỗ @ViewBag.golfname</span></h2>
        <p>Với nhiều Golf Tours, Package, Events hấp dẫn!</p>
        <p>* Lưu ý giá có thể thay đối vào dịp cuối tuần!</p>
        <div id="message"></div>
        <!-- Error message display -->
        <form>
        <fieldset>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="name" accesskey="U" class="wauto"><span class="required">*</span> Họ Tên</label>
                <input name="cname" type="text" id="cname" class="form-control" value=""/>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="email" accesskey="E"><span class="required">*</span> E-mail</label>
                <input name="cemail" type="text" id="cemail" value="" class="form-control"/>
              </div>
            </div>
			<div class="col-md-6">
              <div class="form-group">
                <label for="email" accesskey="E"><span class="required">*</span> Số điện thoại</label>
                <input name="cphone" type="text" id="cphone" value="" class="form-control"/>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="email" accesskey="E">Địa chỉ</label>
                <input name="caddress" type="text" id="caddress" value="" class="form-control"/>
              </div>
            </div>
			<div class="col-md-6">
              <div class="form-group">
                <label for="room"><span class="required">*</span>Loại hố</label> 
                <div id="divholes">                 
                    <select class="form-control" name="holes" id="holes" onchange="selectHoles();">
                      <option selected="selected" disabled="disabled">Chọn số hố</option>
                      <option value="9">9</option>
                      <option value="18">18</option>
                      <option value="27">27</option>
                      <option value="-1">Số khác</option>
                    </select>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="room">Số người chơi</label>                
                <select class="form-control" name="numofguest" id="numofguest">
                  <option selected="selected" value="1">1</option>
                  <option value="2">2</option>    
                  <option value="3">3</option>  
                  <option value="4">4</option>    
                  <option value="5">5</option>
                  <option value="6">6</option>    
                  <option value="7">7</option> 
                  <option value="8">8</option>  
                  <option value="9">9</option> 
                  <option value="10">10</option>   
                  <option value="11">11</option>    
                  <option value="12">12</option>                                         
                </select>
              </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label style="width:auto;display:block;"><span class="required">*</span>Teetime</label>
                    <input name="teetime" type="text" id="teetime" value="" class="form-control" placeholder="ví dụ: 09:00" onblur="getCheckIn();"/>
                </div>
            </div>
			<div class="col-md-6">
              <div class="form-group">
                <label for="room"><span class="required">*</span>Checkin</label>                
                <input name="hcheckin" type="text" id="hcheckin" value="" class="form-control"/>
              </div>
            </div>            
            <div class="col-md-6">
                <div class="form-group">
                        <label style="width:auto;display:block;"><span class="required">*</span>Ngày chơi</label>
                        <input name="checkin" type="text" id="checkin" value="@HotelGolfBooking.Config.convertFromDateIdToDateString(@ViewBag.checkin.ToString())" class="form-control" placeholder="Ngày chơi"/> 
                        <input name="dateplay" type="hidden" id="dateplay" value=""/>                                                 
                </div>
            </div>
			<div class="col-md-6">
              <div class="form-group">
                <label for="room">Có kèm Buggy</label>                
                <select class="form-control" name="buggies" id="buggies">
                  <option selected="selected" value="1">Có</option>
                  <option value="0">Không</option>                  
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="room">Số xe Buggy</label>                
                <select class="form-control" name="numofbuggies" id="numofbuggies">
                  <option selected="selected" value="1">1</option>
                  <option value="2">2</option>    
                  <option value="3">3</option>  
                  <option value="4">4</option>    
                  <option value="5">5</option>
                  <option value="6">6</option>    
                  <option value="7">7</option> 
                  <option value="8">8</option>  
                  <option value="9">9</option> 
                  <option value="10">10</option>   
                  <option value="11">11</option>    
                  <option value="12">12</option>                                         
                </select>
              </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="email" accesskey="E" class="wauto"><span class="required">*</span>Chọn hình thức thanh toán</label>
				    <select class="form-control" name="paymenttype" id="paymenttype">                  
                      <option value="@HotelGolfBooking.Config.payment_method1">@HotelGolfBooking.Config.payment_method1</option>
                      <option value="@HotelGolfBooking.Config.payment_method2" selected>@HotelGolfBooking.Config.payment_method2</option>
                      <option value="@HotelGolfBooking.Config.payment_method3">@HotelGolfBooking.Config.payment_method3</option>
				      <option value="@HotelGolfBooking.Config.payment_method4">@HotelGolfBooking.Config.payment_method4</option>
                    </select>
                </div>
            </div>
          </div>          
          <div class="form-group">
            <label for="comments" accesskey="C"><span class="required">*</span> Ghi chú</label>
            <textarea name="note" rows="9" id="note" class="form-control"></textarea>
          </div>
          <button type="button" class="btn btn-info" onclick="checkField();" id="btnregister">Đăng ký</button>
          @if (ViewBag.ismobile==0)
          {  
          <button type="button" class="btn btn-info" onclick="viewInvoice();" >Xem chi tiết hóa đơn</button>  
          }
        </fieldset>
        </form>
      </div>
    </section>
  </div>
</div>
<div id="loadingImage" name="loadingImage" style="z-index:1000;position:fixed;left:40%;top:20%;width:32px;height:32px;display:none;">
    <img src="/Images/loading.gif">
</div>
<div id="listInvoice" name="listInvoice" style="z-index:1001;position:fixed;left:2%;top:40%;width:90%;height:auto;display:none;background-color:#b6ff00;border:1px solid #b6ff00;">
   <table class="tbl_price_room" id="tblListInvoice">
       <tr><th width="73" style="display:none;">Ngày chơi</th><th width="73">Giá</th><th width="73">Giá xe Buggy</th><th width="73">Phụ thu hố</th><th width="73">Phụ thu xe buggies</th><th width="73">Số khách</th><th width="73">Số xe buggies</th><th width="73">Tổng tiền</th></tr>
       <tr id="tr1">
           <td width="73" style="display:none;"><input type="text" id="playdate1" name="playdate1" value="" style="width:82px;"></td>
           <td width="73"><input type="text" id="price1" name="price1" value="" style="width:82px;" onblur="autocal();"></td>
           <td width="73"><input type="text" id="pricebuggies1" name="pricebuggies1" value="" style="width:82px;" onblur="autocal();"></td>
           <td width="73"><input type="text" id="priceextralhole1" name="priceextralhole1" value="0" style="width:82px;" onblur="autocal();"></td>
           <td width="73"><input type="text" id="priceextralbuggies1" name="priceextralbuggies1" value="" style="width:82px;" onblur="autocal();"></td>
           <td width="73"><input type="text" id="numofguest1" name="numofguest1" value="0" style="width:82px;" onblur="autocal();"></td>
           <td width="73"><input type="text" id="numofbuggies1" name="numofbuggies1" value="0" style="width:82px;" onblur="autocal();"></td>
           <td width="73"><input type="text" id="totalprice1" name="totalprice1" value="0" style="width:82px;" onblur="autocal();"></td>
       </tr>
       <tr>
           <td style="display:none;"></td>
           <td id="sumprice"></td>
           <td id="sumpricebuggies"></td>
           <td id="sumpriceextralhole"></td>
           <td id="sumpriceextralbuggies"></td>
           <td id="sumnumofguest"></td>
           <td id="sumnumofbuggies"></td>
           <td id="sumntotalprice"></td>
           
       </tr>  
       <tr><td colspan="10"><a onclick="$('#listInvoice').hide();" class="btn btn-info">Đóng lại</a></td></tr>
    </table>
</div>
<!-- Gallery -->
<section class="gallery-slider mt100">
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <h2 class="lined-heading"><span>Sân golf nhiều người quan tâm</span></h2>
      </div>
    </div>
  </div>
  <div id="owl-gallery" class="owl-carousel" >
        @Html.Raw(@ViewBag.gallery)
  </div>
</section>
<script>
    function selectHoles(){
        if (parseInt($("#holes").val())%9!=0){
            $("#divholes").html("<input type=text id=holes name=holes placeholder=\"Nhập số hố\">");
        }
    }
    function getCheckIn(){
        if(!checkTimeFormat($("#teetime").val())){
            alert("Nhập teetime sai định dạng hh:mm");
            $("#teetime").focus();
            return;
        }
        var obj=document.getElementById("teetime");
        var hh= obj.value.substring(0, 2);
        var mm= obj.value.substring(3, 5);
        var total=parseInt(hh)*60+parseInt(mm)-30;
        hh=total/60;
        hh=parseInt(hh);
        mm=total%60;
        if (hh<10) hh="0"+hh;
        if (mm<10) mm="0"+mm;
        $("#hcheckin").val(hh+":"+mm);
    }
    function checkField() {
        //check field
        //alert($("#time").val());
        //alert($("#hcheckin").val());
        //alert($("#teetime").val());
        //return;
        if($("#cname").val()==""){
            alert("Nhập họ tên khách hàng");
            $("#cname").focus();
            return;
        }
        if($("#cemail").val()==""){
            alert("Nhập email");
            $("#cemail").focus();
            return;
        }
        if($("#cphone").val()==""){
            alert("Nhập số điện thoại");
            $("#cphone").focus();
            return;
        }
        if($("#holes").val()==null || isNaN($("#holes").val())){
            alert("Nhập số hố");
            $("#holes").focus();
            return;
        }

        if($("#teetime").val()==""){
            alert("Nhập teetime");
            $("#teetime").focus();
            return;
        }
        if($("#numofguest").val()==""){
            alert("Nhập số người chơi");
            $("#numofguest").focus();
            return;
        }
        
        if($("#buggies").val()==1 && $("#numofbuggies").val()==""){
            alert("Nhập số xe buggy");
            $("#numofbuggies").focus();
            return;
        }
        document.getElementById("btnregister").disabled=true;
        
        //document.getElementById("fromtime").value=document.getElementById("checkin").value+" "+document.getElementById("ffromtime").value;
        //document.getElementById("totime").value=document.getElementById("checkin").value+" "+document.getElementById("ttotime").value;
        //document.getElementById("EditForm").submit();
        document.getElementById("dateplay").value=getDateId(document.getElementById("checkin").value);
        //alert(document.getElementById("dateplay").value);
        var formdata = new FormData(); //FormData object
        formdata.append("idgolf", @ViewBag.idgolf);
        formdata.append("golfname", "@Html.Raw(@ViewBag.golfname)");
        formdata.append("provin", "@Html.Raw(@ViewBag.provin)");
        formdata.append("cname", $("#cname").val());
        formdata.append("cemail", $("#cemail").val());
        formdata.append("cphone", $("#cphone").val());
        formdata.append("caddress", $("#caddress").val());
        formdata.append("holes", $("#holes").val());
        formdata.append("numofbuggies", $("#numofbuggies").val());
        formdata.append("numofguest", $("#numofguest").val());
        formdata.append("buggies", $("#buggies").val());
        formdata.append("checkin", document.getElementById("hcheckin").value);
        formdata.append("teetime", document.getElementById("teetime").value);     
        formdata.append("dateplay", document.getElementById("dateplay").value);
        formdata.append("note", $("#note").val());
        formdata.append("paymenttype", $("#paymenttype").val());
        formdata.append("typebook", @ViewBag.typebook);
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/GolfBooking/addNew');
        xhr.send(formdata);        
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) { 
                if(xhr.responseText!="0"){
                    //alert("Xác nhận đặt phòng thành công! Chúng tôi sẽ liên hệ với khách hàng qua email và điện thoại sớm nhất!");
                    //if ($("#paymenttype").val()=="Chuyển khoản Ebanking"){
                    //window.location.href="/HotelBooking/Payment?idhotel=@ViewBag.idhotel&code=@ViewBag.code";
                    //}else{
                    window.location.href="/GolfBooking/ConfirmEmail";
                    //}
                }else{
                    alert("Chương trình đang cập nhật, mời bạn quay lại sau!");
                }
            }
        }
    }
    function valNum(v){
        v=removeSpecialCharater(v);
        return parseInt(v);
    }
    function isNum(v){
        if (v=="" || v==null) return false;
        v=removeSpecialCharater(v);
        return !isNaN(v);
    }
    //getNewsGolfList();
    //getGolfListGallery();
    function clearInvoice(){
       
        for(var index=1;index<=1;index++){
            $("#playdate"+index).val("");
            $("#price"+index).val("");
            $("#pricebuggies"+index).val("");
            $("#priceextralhole"+index).val("");
            $("#priceextralbuggies"+index).val("");
            $("#numofguest"+index).val("0");
            $("#numofbuggies"+index).val("0");
            $("#totalprice"+index).val("0");
            $("#noteextrafee"+index).val("");
        }
       
        $("#sumprice").html("");
        $("#sumpricebuggies").html("");
        $("#sumpriceextralhole").html("");
        $("#sumpriceextralbuggies").html("");
        $("#sumnumofguest").html("");
        $("#sumnumofbuggies").html("");
        $("#sumntotalprice").html("");
        //removeItem(4);
        //removeItem(2);
        totalitem=1;
    }
    function autocal(){
        var sumprice=0;
        var sumpricebuggies=0;
        var sumpriceextralhole=0;
        var sumpriceextralbuggies=0;    
        var sumnumofguest=0;
        var sumnumofbuggies=0;
        var sumntotalprice=0;
        var tempsumprice=0;
        var temsumextrabuggy=0;
        for(var index=1;index<=totalitem;index++){
            if (!document.getElementById("price" + index)||!document.getElementById("totalprice" + index)) continue;
           
            //alert($("#total"+index).val());
            sumprice+=valNum($("#price"+index).val());
            sumpricebuggies+=valNum($("#pricebuggies"+index).val());
            sumpriceextralhole+=valNum($("#priceextralhole"+index).val());
            sumpriceextralbuggies+=valNum($("#priceextralbuggies"+index).val());  
            sumnumofguest+=valNum($("#numofguest"+index).val());  
            sumnumofbuggies+=valNum($("#numofbuggies"+index).val());  
            tempsumprice=valNum($("#numofguest"+index).val())*valNum($("#price"+index).val())+valNum($("#numofbuggies"+index).val())*valNum($("#pricebuggies"+index).val())+valNum($("#priceextralhole"+index).val());
            //alert(tempsumprice);
            sumntotalprice+=tempsumprice;
            temsumextrabuggy=valNum($("#numofbuggies"+index).val())*valNum($("#pricebuggies"+index).val());
            $("#totalprice"+index).val(formatCurrency(tempsumprice));
            $("#priceextralbuggies"+index).val(formatCurrency(temsumextrabuggy));
        }
        //alert(sumtotal);
        $("#sumprice").html("<b>"+formatCurrency(sumprice)+"</b>");
        $("#sumpricebuggies").html("<b>"+formatCurrency(sumpricebuggies)+"</b>");
        $("#sumpriceextralhole").html("<b>"+formatCurrency(sumpriceextralhole)+"</b>");
        $("#sumpriceextralbuggies").html("<b>"+formatCurrency(sumpriceextralbuggies)+"</b>");
        $("#sumnumofguest").html("<b>"+formatCurrency(sumnumofguest)+"</b>");
        $("#sumnumofbuggies").html("<b>"+formatCurrency(sumnumofbuggies)+"</b>");
        $("#sumntotalprice").html("<b>"+formatCurrency(sumntotalprice)+"</b>");
    }
    function viewInvoice(idbooking,idgolf, numofbuggies, numofguest, dateplay,typebook){
        if($("#numofguest").val()==""){
            alert("Nhập số người chơi");
            $("#numofguest").focus();
            return;
        }
        
        if($("#buggies").val()==1 && $("#numofbuggies").val()==""){
            alert("Nhập số xe buggy");
            $("#numofbuggies").focus();
            return;
        }

        idbooking=-1;
        idgolf=@ViewBag.idgolf;
        dateplay=getDateId(document.getElementById("checkin").value);

        numofbuggies=document.getElementById("numofbuggies").value;
        numofguest=document.getElementById("numofguest").value;
        typebook=@ViewBag.typebook;
        //currentIdbooking=idbooking;
        showLoadingImage(); 
        clearInvoice();
        $("#listInvoice").show();
        var formdata = new FormData(); //FormData object
        formdata.append("idbooking", idbooking);
        formdata.append("idgolf", idgolf);
        formdata.append("numofbuggies", numofbuggies);
        formdata.append("numofguest", numofguest);
        formdata.append("dateplay", dateplay);
        formdata.append("typebook", typebook);
       
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/GolfBooking/viewInvoice');
        xhr.send(formdata);
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                hideLoadingImage();
                var news = '{"news":' + xhr.responseText + '}';
                //alert(news);
                var json_parsed = $.parseJSON(news);
                var sumprice=0;
                var sumpricebuggies=0;
                var sumpriceextralhole=0;
                var sumpriceextralbuggies=0;    
                var sumnumofguest=0;
                var sumnumofbuggies=0;
                var sumntotalprice=0;
                var from=totalitem;
                //alert(totalitem+"-"+json_parsed.news.length);
                for(var j=from;j<json_parsed.news.length;j++){
                    if (json_parsed.news[j] && json_parsed.news[j].price!=null && json_parsed.news[j].price!=0){addItem(j);}
                }
                for (var i = 0; i < json_parsed.news.length; i++) {
                    if (json_parsed.news[i]) {
                        var n=json_parsed.news[i];
                        var index=i+1;
                        if (n.price!=null && n.price!=0){
                            totalitem++;
                            $("#playdate"+index).val(convertFromDateIdToDateString(n.playdate+""));
                            $("#price"+index).val(formatCurrency(n.price));
                            $("#pricebuggies"+index).val(formatCurrency(n.pricebuggies));
                            $("#priceextralhole"+index).val(formatCurrency(n.priceextralhole));
                            $("#priceextralbuggies"+index).val(formatCurrency(n.priceextralbuggies));
                            $("#numofguest"+index).val(n.numofguest);
                            $("#numofbuggies"+index).val(n.numofbuggies);
                            $("#totalprice"+index).val(formatCurrency(n.totalprice));
                            $("#noteextrafee"+index).val(n.noteextrafee);
                            sumprice+=n.price;
                            sumpricebuggies+=n.pricebuggies;
                            sumpriceextralhole+=n.priceextralhole;
                            sumpriceextralbuggies+=n.priceextralbuggies;
                            sumnumofguest+=n.numofguest;
                            sumnumofbuggies+=n.numofbuggies;
                            sumntotalprice+=n.totalprice;
                        }
                    }
                }
                totalprice=sumntotalprice;
                $("#sumprice").html("<b>"+formatCurrency(sumprice)+"</b>");
                $("#sumpricebuggies").html("<b>"+formatCurrency(sumpricebuggies)+"</b>");
                $("#sumpriceextralhole").html("<b>"+formatCurrency(sumpriceextralhole)+"</b>");
                $("#sumpriceextralbuggies").html("<b>"+formatCurrency(sumpriceextralbuggies)+"</b>");
                $("#sumnumofguest").html("<b>"+formatCurrency(sumnumofguest)+"</b>");
                $("#sumnumofbuggies").html("<b>"+formatCurrency(sumnumofbuggies)+"</b>");
                $("#sumntotalprice").html("<b>"+formatCurrency(sumntotalprice)+"</b>");
            }
        }
    }
</script>